<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="testMapper">


	<resultMap type="kh.study.academy.test.vo.TestVO"			id="test">
		<id column="TEST_CODE" 									property="testCode" />
		<result column="TEST_DATE" 								property="testDate" />
		<result column="SCORE" 									property="score" />
		
		
		<!-- 아래 칼럼 수정 필요 -->
		<result column="SUBJECT_CODE" 							property="subjectCode" />
		<result column="STUDENT_CODE" 							property="studentCode" />
		
		
		
	</resultMap>

	
	

	
	<!-- 점수 등록 -->
	<insert id="regScore">
		 <selectKey resultType="String" keyProperty="testCode" order="BEFORE">
	         SELECT 'TEST_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(TEST_CODE, 6))), 0) + 1, 3, 0) 
	         FROM TEST
	    </selectKey>

	INSERT INTO TEST (
		TEST_CODE
		, TEST_DATE
		, SCORE
		, SUBJECT_CODE
		, STUDENT_CODE
	) VALUES(
		#{testCode}
		, #{testDate}
		, #{score}
		, #{subjectCode}
		, #{studentCode}
	)
	</insert>

	
	
	
	<!-- 평가 관리 페이지에서 검색 조회 -->
	<!--수정필요// studentMapper 모든학생이 듣고 있는 수업 조회 참고 -->
	<select id="searchTest" resultMap="studentMapper.student"
		parameterType="hashMap">
		SELECT S.STUDENT_CODE
		    , STUDENT_NAME
		    , STUDENT_YEAR
		    , STUDENT_GENDER
		    , STUDENT_LESSON_CODE
		    , L.LESSON_INFO_CODE
		    , (SELECT SUBJECT_NAME
						FROM SUBJECT
						WHERE SUBJECT_CODE = L.SUBJECT_CODE) AS SUBJECT_NAME
		    , (SELECT STEP_NAME
						FROM STEP
						WHERE STEP_CODE = L.STEP_CODE) AS STEP_NAME
		    , YEAR
		    , L.TEACHER_CODE 
	        , TEACHER_NAME
		FROM LESSON_INFO L, STUDENT_LESSON_INFO SL , STUDENT S, TEACHER T
		WHERE L.LESSON_INFO_CODE = SL.LESSON_INFO_CODE
		AND S.STUDENT_CODE = SL.STUDENT_CODE
	    AND L.TEACHER_CODE = T.TEACHER_CODE
		<if test="studentName != null and !studentName.equals('')">
			AND STUDENT_NAME LIKE ('%'||#{studentName}||'%')
		</if>
		<if test="teacherName != null and !teacherName.equals('')">
			AND TEACHER_NAME LIKE ('%'||#{teacherName}||'%')
		</if>
		<if test="lessonInfoCode != null and !lessonInfoCode.equals('')">
			AND LESSON_INFO_CODE LIKE ('%'||#{lessonInfoCode}||'%')
		</if>
	</select>
	
	
	
	
	
	
	
	<!-- 통계(반별 테스트 평균점수를 차트화) -->
	<!-- 검토필요 -->
	<select id="selectLessonScore" resultMap="test">
		SELECT TEST_CODE
			, TEST_DATE
			, SCORE
			, STUDENT_CODE
			, LESSON_INFO_CODE
		FROM TEST
		WHERE LESSON_INFO_CODE = #{lessonInfoCode}
	</select>
	
	
	
	
	
	
	<!-- 점수 수정  -->
	<update id="updateScore">
		UPDATE TEST
		SET
		SCORE = #{score}
		WHERE TEST_CODE = #{testCode}
	</update>
	
	
	<!-- 점수 삭제 -->
	<delete id="deleteScore">
		DELETE TEST
		WHERE TEST_CODE = #{testCode}
	</delete>


	
</mapper>
























